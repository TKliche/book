[[ch_introduction_stomp_example]]
=== +Locations+ Application Using STOMP

Let's take the example of a delivery company like UPS that manages a fleet of trucks.
Each truck is responsible for the delivery of packages.
They receive orders from their headquarter to:

* fetch packages at the company's warehouses
* deliver packages to the customer's addresses

To manage efficiently all the trucks, the company head quarters want to monitor the truck's positions and be able to send them orders on-the-go.

We will build a very simple iOS application named +Locations+ that looks similar to this example. This application will broadcast the device's geolocation data (using is GPS sensor).
It will also display text messages that it receives from a destination.

The pending Web application will display the locations of all the devices on a map. it will also be used to send text messages to a given devices.

. In <<ch_mobile_stomp>>, we will write the +Locations+ iOS application using the STOMP protocol to send GPS data and receive text from an iOS device.
. In <<ch_web_stomp>>, we will write a Web application using STOMP protocol over Web Sockets to receive GPS data in a Web browser and send text to the devices.

[[img_example_app_1]]
.The +Locations+ application with two devices, +AAA+ and +BBB+ and one Web application.
image::images/Chapter011/stomp_app_diagram_1.png["Diagram of the Locations application"]

Before introducing the messaging protocol that will be used by the application, we can already define 
the application's messaging topology and how the different parts of the application will exchange messages.

[[ch_introduction_stomp_example_topology]]
==== Locations Messaging Topology

Each device will be associated to two destinations:

* a topic to broadcast its GPS geolocation data: +device.XXX.location+ where +XXX+ is the device identifier
* a queue to receive simple text message : +device.XXX.text+

A topic is used to send the GPS data as this allows potentially many consumers to receive the information.

However a queue is used to handle the device's text as only one single device will consume messages from this destination.
It does not make sense for any other consumers to receive it.

Each device running the +Locations+ application will be:

* a _producer_ of messages to the topic +device.XXX.location+
* a _consumer_ of messages from the queue +device.XXX.text+

Conversely, the Web application will be:

* a _consumer_ of messages from all the topics +device.XXX.location+
* a _producer_ of message from the queues +device.XXX.text+

[[ch_introduction_stomp_example_message]]
==== Locations Message Representation

There will be two types of exchanged messages:

* one to represent GPS data (sent to the topics +device.XXX.location+)
* one to represent orders (sent to the queues +device.XXX.text+)

===== Geolocation messages
The Truck app will send the GPS data using a JSON representation:

[[ex_example_gps_data]]
.Geolocation data representation
====
----
{
  "deviceID": "BBB",<1>
  "lat": 48.8581,<2>
  "lng": 2.2946,<3>
  "ts": "2013-09-23T08:43Z"<4>
}
----
<1> +deviceID+ is the identifier of the device that sends its position
<2> +lat+ is a number representing the position's _latitude_
<3> +lng+ is a number representing the position's _longitude_
<4> +ts+ is a string representing the time when the position was taken (using the http://en.wikipedia.org/wiki/ISO_8601[ISO 8601] format)
====

===== Text messages
The text messages that will be consumed by the +Locations+ iOP app will
be represented as a simple plain text string.

[[ex_example_text]]
.Text data representation
====
----
"Where are you heading to?"
----
====

A more realistic representation of this message would also contain the name of the person sending the message, etc. We are using a plain text version as this
format is enough to provide a first version.

With the messaging topology and data representation known, we can already refine the application diagram.

[[img_example_app_2]]
.The +Locations+ application's data workflow.
image::images/Chapter011/stomp_app_diagram_2.png["Diagram of the Locations application data worflow"]

